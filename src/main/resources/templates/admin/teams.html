<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/layout :: head">
    <title>팀 관리 - Cheerlot</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>관리자 메뉴</span>
                    </h6>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin}">
                                <i class="bi bi-house"></i>
                                대시보드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin/players}">
                                <i class="bi bi-people"></i>
                                선수 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/admin/teams}">
                                <i class="bi bi-shield"></i>
                                팀 관리
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- 메인 콘텐츠 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- 페이지 헤더 -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h2">팀 관리</h1>
                    </div>
                </div>
                
                <!-- 알림 메시지 -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- 페이지 컨텐츠 -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2>팀 관리</h2>
                                <p class="text-muted">각 팀의 마지막 업데이트 날짜와 상대팀 정보를 관리할 수 있습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 팀 목록 테이블 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-shield"></i> 
                                    팀 목록 
                                    <span class="badge bg-secondary" th:text="${#lists.size(teams)}">0</span>
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div th:if="${#lists.isEmpty(teams)}" class="text-center p-5">
                                    <i class="bi bi-shield-x text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted mt-3">등록된 팀이 없습니다</h5>
                                    <p class="text-muted">크롤링을 실행하여 팀 정보를 가져와주세요.</p>
                                </div>
                                
                                <div th:if="${!#lists.isEmpty(teams)}" class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>팀 코드</th>
                                                <th>팀명</th>
                                                <th>등록 선수 수</th>
                                                <th>마지막 업데이트</th>
                                                <th>상대팀</th>
                                                <th>관리</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="team : ${teams}" th:id="'team-' + ${team.teamCode}">
                                                <td>
                                                    <span class="badge bg-primary" th:text="${team.teamCode}">CODE</span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                             style="width: 30px; height: 30px; font-size: 0.8rem;">
                                                            <span th:text="${#strings.substring(team.name, 0, 1)}">팀</span>
                                                        </div>
                                                        <strong th:text="${team.name}">팀명</strong>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info" th:text="${team.playerCount}">0</span>
                                                    <small class="text-muted">명</small>
                                                </td>
                                                <td>
                                                    <div class="team-info" th:data-team-code="${team.teamCode}">
                                                        <span class="display-mode">
                                                            <span th:if="${team.lastUpdated != null}" 
                                                                  th:text="${#temporals.format(team.lastUpdated, 'yyyy-MM-dd')}"
                                                                  class="text-muted">-</span>
                                                            <span th:if="${team.lastUpdated == null}" class="text-muted">설정안됨</span>
                                                        </span>
                                                        <div class="edit-mode d-none">
                                                            <input type="date" class="form-control form-control-sm" 
                                                                   th:value="${team.lastUpdated}">
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="team-info" th:data-team-code="${team.teamCode}">
                                                        <span class="display-mode">
                                                            <span th:if="${team.lastOpponent != null and team.lastOpponent != ''}" 
                                                                  th:text="${team.lastOpponent}"
                                                                  class="text-primary">-</span>
                                                            <span th:if="${team.lastOpponent == null or team.lastOpponent == ''}" class="text-muted">설정안됨</span>
                                                        </span>
                                                        <div class="edit-mode d-none">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   th:value="${team.lastOpponent}" placeholder="상대팀 입력">
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-primary edit-btn" 
                                                                th:data-team-code="${team.teamCode}" title="수정">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success save-btn d-none" 
                                                                th:data-team-code="${team.teamCode}" title="저장">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary cancel-btn d-none" 
                                                                th:data-team-code="${team.teamCode}" title="취소">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 도움말 -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-lightbulb"></i> 사용 방법</h6>
                                <ul class="mb-0">
                                    <li>수정 버튼을 클릭하여 팀 정보를 편집할 수 있습니다.</li>
                                    <li>마지막 업데이트 날짜는 YYYY-MM-DD 형식으로 입력해주세요.</li>
                                    <li>상대팀은 텍스트로 자유롭게 입력할 수 있습니다.</li>
                                    <li>저장 버튼을 클릭하면 변경사항이 저장됩니다.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 수정 버튼 클릭 이벤트
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const teamCode = this.getAttribute('data-team-code');
                    enableEditMode(teamCode);
                });
            });
            
            // 저장 버튼 클릭 이벤트
            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const teamCode = this.getAttribute('data-team-code');
                    saveTeamInfo(teamCode);
                });
            });
            
            // 취소 버튼 클릭 이벤트
            document.querySelectorAll('.cancel-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const teamCode = this.getAttribute('data-team-code');
                    cancelEditMode(teamCode);
                });
            });
        });
        
        function enableEditMode(teamCode) {
            const row = document.getElementById('team-' + teamCode);
            const teamInfos = row.querySelectorAll('.team-info');
            
            teamInfos.forEach(info => {
                info.querySelector('.display-mode').classList.add('d-none');
                info.querySelector('.edit-mode').classList.remove('d-none');
            });
            
            // 버튼 상태 변경
            row.querySelector('.edit-btn').classList.add('d-none');
            row.querySelector('.save-btn').classList.remove('d-none');
            row.querySelector('.cancel-btn').classList.remove('d-none');
            
            // 첫 번째 input에 포커스
            const firstInput = row.querySelector('.edit-mode input');
            if (firstInput) {
                firstInput.focus();
            }
        }
        
        function cancelEditMode(teamCode) {
            const row = document.getElementById('team-' + teamCode);
            const teamInfos = row.querySelectorAll('.team-info');
            
            teamInfos.forEach(info => {
                info.querySelector('.display-mode').classList.remove('d-none');
                info.querySelector('.edit-mode').classList.add('d-none');
            });
            
            // 버튼 상태 복원
            row.querySelector('.edit-btn').classList.remove('d-none');
            row.querySelector('.save-btn').classList.add('d-none');
            row.querySelector('.cancel-btn').classList.add('d-none');
        }
        
        function saveTeamInfo(teamCode) {
            const row = document.getElementById('team-' + teamCode);
            const inputs = row.querySelectorAll('.edit-mode input');
            
            const lastUpdated = inputs[0].value;
            const lastOpponent = inputs[1].value;
            
            // 저장 버튼 비활성화
            const saveBtn = row.querySelector('.save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-hourglass"></i>';
            
            // 폼 데이터 준비
            const formData = new FormData();
            formData.append('lastUpdated', lastUpdated);
            formData.append('lastOpponent', lastOpponent);
            
            // 서버로 POST 요청
            fetch(`/admin/teams/${teamCode}/update`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // 성공시 페이지 새로고침
                    window.location.reload();
                } else {
                    throw new Error('서버 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('팀 정보 저장 중 오류가 발생했습니다.');
                
                // 버튼 복원
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });
        }
    </script>
</body>
</html> 